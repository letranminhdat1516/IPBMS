#!/usr/bin/env sh

# Lightweight, faster pre-commit hook using lint-staged and optional full checks.
# - Set SKIP_HOOKS=1 to skip the hook entirely (useful for CI or special cases)
# - Set FULL_PRECOMMIT=1 to run the full test + build pipeline (slow)

set -e

echo "ğŸ” Running pre-commit checks..."

if [ "${SKIP_HOOKS}" = "1" ] || [ "${SKIP_HOOKS}" = "true" ]; then
    echo "âš ï¸  SKIP_HOOKS set â€” skipping pre-commit checks."
    exit 0
fi

# Prefer lint-staged if available (runs ESLint + Prettier only on staged files)
echo "ğŸ”§ Running lint-staged (ESLint + Prettier) on staged files..."
if pnpm -v >/dev/null 2>&1 && command -v npx >/dev/null 2>&1; then
    # Use pnpm lint-staged if configured; fallback to npx lint-staged if needed
    if pnpm -s lint-staged; then
        echo "âœ… lint-staged passed."
    else
        echo "âŒ lint-staged failed. Run 'pnpm lint:fix' and 'pnpm format' to attempt fixes."
        exit 1
    fi
else
    echo "âš ï¸  pnpm or npx not available â€” running full lint/format checks as fallback."
    if ! pnpm -s lint:quiet; then
        echo "âŒ ESLint found errors. Run 'pnpm lint:fix' to auto-fix issues."
        exit 1
    fi
    if ! pnpm -s format:check; then
        echo "âŒ Code formatting issues found. Run 'pnpm format' to fix."
        exit 1
    fi
fi

# Always run a fast TypeScript check to catch obvious type errors
echo "ğŸ” Running TypeScript type check..."
if ! pnpm -s type-check; then
    echo "âŒ TypeScript type errors found. Please fix them before committing."
    exit 1
fi

# Optionally run full tests + build if FULL_PRECOMMIT is set (useful for release branches)
if [ "${FULL_PRECOMMIT}" = "1" ] || [ "${FULL_PRECOMMIT}" = "true" ]; then
    echo "ğŸ§ª FULL_PRECOMMIT enabled â€” running full tests and build (this may take a while)..."
    if ! pnpm -s test --silent; then
        echo "âŒ Tests failed. Please fix them before committing."
        exit 1
    fi

    echo "ğŸ”¨ Running build..."
    if ! pnpm -s build; then
        echo "âŒ Build failed. Please fix build errors before committing."
        exit 1
    fi
else
    echo "â„¹ï¸  Skipping full test/build. Set FULL_PRECOMMIT=true to enable."
fi

echo "âœ… All pre-commit checks passed. Ready to commit."